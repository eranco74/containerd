# Generated by Butane; do not edit
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: 98-containerd-config
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - contents:
            compression: ""
            source: data:;base64,W3BsdWdpbnNdCiAgW3BsdWdpbnMuY3JpLmNuaV0KICBiaW5fZGlyID0gIi92YXIvbGliL2NuaS9iaW4iCiAgY29uZl9kaXIgPSAiL3Zhci9ydW4vbXVsdHVzL2NuaS9uZXQuZC8i
          mode: 420
          path: /etc/containerd/config.toml
        - contents:
            compression: gzip
            source: data:;base64,H4sIAAAAAAAC/yoqzSvJzE3VTc1LKcjPzCuxUijNy6yw0tfXLyrN00/OzytJzMxLLUpBYuoV5ydnc2XmJqaTrg0QAAD//3H8xzlvAAAA
          mode: 420
          path: /etc/crictl.yaml
        - contents:
            compression: gzip
            source: data:;base64,H4sIAAAAAAAC/4ySQW/UMBCF7/4V010OcLC9aXerCq70AAdAvSKEHGeysUhmjD3ZrSp+PHI2aUFlRa+j8ef33rz1hR1zsnUgi3SA2uVOZRTQOPItxBCxdaGH9Rr0LXCUwATH0Pfg3ZgR2pF8mWUQhkAdpiAgyUWlVGjhK+gWEsbeedQ+BdbHIJ32TOICYWpMw4Tw7R1Ih6QA0HcMq08sXaB9YTa8KuP7ILBRbViwFyfwwIcT99+cu7JQQGWlcFIcNGdJiMAHTCk0OFPg1esUB9A/HfzaJ4zlieY3CkB49N2zvyYtT1ICZXF9PztDOufsPR+pZ9dMoh5TKNL8mHrQn0F/hE4kvrU2Ov/D7TEbHLVHkuR6XRk3uAcmd8zG82AvN9WN2VzZMTZOMFvXINa73bZ27c7e31x/v97aLzPHPn2oK7M11ZW+NAX4QJU57ZoUB/Uo9sPJ1HOtf8Q4G4cXspc4z+Q1pbokRThXZ7kglPL8JWW5zX8KtjDvsGaWqVkdAnGDK5WmmfodAAD//9HP52kIAwAA
          mode: 484
          path: /usr/local/bin/replace-crio-with-containerd.sh
    systemd:
      units:
        - contents: |
            [Unit]
            Description=containerd container runtime
            Documentation=https://containerd.io
            After=network.target local-fs.target replace-crio-with-containerd.service
            [Service]
            ExecStartPre=-/sbin/modprobe overlay
            ExecStart=/bin/containerd --config /etc/containerd/config.toml
            Type=notify
            Delegate=yes
            KillMode=process
            Restart=always
            RestartSec=5
            # Having non-zero Limit*s causes performance problems due to accounting overhead
            # in the kernel. We recommend using cgroups to do container-local accounting.
            LimitNPROC=infinity
            LimitCORE=infinity
            LimitNOFILE=infinity
            # Comment TasksMax if your systemd version does not supports it.
            # Only systemd 226 and above support this version.
            TasksMax=infinity
            OOMScoreAdjust=-999
            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: containerd.service
        - contents: |
            [Unit]
            Description=Kubernetes Kubelet
            Wants=rpc-statd.service network-online.target
            Requires=containerd.service kubelet-auto-node-size.service
            After=network-online.target containerd.service kubelet-auto-node-size.service
            After=ostree-finalize-staged.service

            [Service]
            Type=notify
            ExecStartPre=/bin/mkdir --parents /etc/kubernetes/manifests
            ExecStartPre=/bin/rm -f /var/lib/kubelet/cpu_manager_state
            ExecStartPre=/bin/rm -f /var/lib/kubelet/memory_manager_state
            EnvironmentFile=/etc/os-release
            EnvironmentFile=-/etc/kubernetes/kubelet-workaround
            EnvironmentFile=-/etc/kubernetes/kubelet-env
            EnvironmentFile=/etc/node-sizing.env

            ExecStart=/usr/bin/hyperkube \
                kubelet \
                  --config=/etc/kubernetes/kubelet.conf \
                  --bootstrap-kubeconfig=/etc/kubernetes/kubeconfig \
                  --kubeconfig=/var/lib/kubelet/kubeconfig \
                  --container-runtime=remote \
                  --container-runtime-endpoint=/var/run/containerd/containerd.sock \
                  --runtime-cgroups=/system.slice/containerd.service \
                  --node-labels=node-role.kubernetes.io/worker,node.openshift.io/os_id=${ID} \
                  --node-ip=${KUBELET_NODE_IP} \
                  --address=${KUBELET_NODE_IP} \
                  --minimum-container-ttl-duration=6m0s \
                  --volume-plugin-dir=/etc/kubernetes/kubelet-plugins/volume/exec \
                  --cloud-provider= \
                   \
                  --hostname-override=${KUBELET_NODE_NAME} \
                  --pod-infra-container-image=quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:3eae807eb2d1f539ffa799861749eddb8606932fbfd6ef5e82aaa287348b7a07 \
                  --system-reserved=cpu=${SYSTEM_RESERVED_CPU},memory=${SYSTEM_RESERVED_MEMORY} \
                  --v=${KUBELET_LOG_LEVEL}

            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: kubelet.service
        - contents: |
            [Install]
            WantedBy=multi-user.target
            [Unit]
            Description=Fake CRI-O socket for OpenShift SDN
            Requires=containerd.service
            After=containerd.service
            [Service]
            Type=oneshot
            ExecStart=/bin/sh -c "mkdir -p /var/run/crio && touch /var/run/crio/crio.sock && mount --bind /var/run/containerd/containerd.sock /var/run/crio/crio.sock"
          enabled: true
          name: fake-crio-sock-for-sdn.service
        - contents: |
            [Install]
            WantedBy=multi-user.target
            [Unit]
            Description=replace CRI-O with containerd
            Requires=network.target
            After=ostree-finalize-staged.service
            [Service]
            Type=oneshot
            ExecStartPre=/bin/mkdir -p /opt/replace-crio-with-containerd
            WorkingDirectory=-/opt/replace-crio-with-containerd
            # Would prefer to do Restart=on-failure instead of this bash retry loop, but
            # the version of systemd we have right now (239) doesn't support it. It should be
            # available in systemd v244 and higher.
            ExecStart=/bin/bash -c " \
              until /usr/local/bin/replace-crio-with-containerd.sh; \
              do \
              echo 'Failed to execute replace-crio-with-containerd.sh, going to retry in 10 seconds' \
              sleep 10; \
              done"
          enabled: true
          name: replace-crio-with-containerd.service
